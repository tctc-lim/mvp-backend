// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles enum
enum UserRole {
  SUPER_ADMIN
  ADMIN
  ZONAL_COORDINATOR
  CELL_LEADER
  FOLLOW_UP_TEAM
}

// User model for authentication and authorization
model User {
  id              String         @id @default(uuid())
  email           String         @unique
  phone           String         @default("N/A") // âœ… Provide a default value
  password        String
  role            UserRole
  name            String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  zone            Zone?          @relation("ZonalCoordinator")
  cell            Cell?          @relation("CellLeader")
  assignedFollowUps FollowUp[]   @relation("AssignedFollowUps")
  verifiedMilestones MemberMilestone[]
  mustChangePassword Boolean  @default(false)
  resetToken String? // Add resetToken field
  resetTokenExpires DateTime?
  refreshTokens    RefreshToken[]

  @@index([email])
  @@index([role])
  @@index([phone])
}

// Zone model for church zones
model Zone {
  id          String    @id @default(uuid())
  name        String
  description String?
  coordinator User      @relation("ZonalCoordinator", fields: [userId], references: [id])
  userId      String    @unique
  cells       Cell[]
  members     Member[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Cell model for church cells
model Cell {
  id        String    @id @default(uuid())
  name      String
  leader    User      @relation("CellLeader", fields: [userId], references: [id])
  userId    String    @unique
  zone      Zone      @relation(fields: [zoneId], references: [id])
  zoneId    String
  members   Member[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Member status enum
enum MemberStatus {
  FIRST_TIMER
  SECOND_TIMER
  FULL_MEMBER  // After 3 Sunday attendances
}

// Add this new enum for conversion status
enum ConversionStatus {
  NOT_CONVERTED
  NEW_CONVERT    // Can be any member who has given their life to Christ
  REDEDICATED    // For existing believers who rededicated their lives
}

// Add new enums
enum InterestCategory {
  FREE_SKILLS
  MOVIE_ACADEMY
  SHOP_FOR_FREE
  FREE_CENTER_FOR_EDUCATION
  FREE_SPORTS_ACADEMY
}

enum EducationLevel {
  PRIMARY
  SSCE
  GRADUATE
  POST_GRADUATE
}

enum AgeRange {
  AGE_15_20
  AGE_21_30
  AGE_31_40
  AGE_41_50
  AGE_51_ABOVE
}

// Member model for church members
model Member {
  id              String           @id @default(uuid())
  name            String
  email           String?          @unique
  phone           String
  address         String
  gender          String
  status          MemberStatus     @default(FIRST_TIMER)
  conversionStatus ConversionStatus @default(NOT_CONVERTED)
  zone            Zone             @relation(fields: [zoneId], references: [id])
  zoneId          String
  cell            Cell             @relation(fields: [cellId], references: [id])
  cellId          String
  firstVisit      DateTime         @default(now())
  lastVisit       DateTime         @default(now())
  prayerRequest   String?
  followUps       FollowUp[]
  milestones      MemberMilestone[]
  departments     MemberDepartment[]
  sundayAttendance Int             @default(0)  // Track number of Sunday services
  conversionDate  DateTime?        // When they became a new convert
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  attendance      Attendance[]
  notes           Note[]
  
  // New fields
  interests       InterestCategory[]
  educationLevel  EducationLevel?
  ageRange        AgeRange?
  birthDate       DateTime?  // Stores only day and month
  badComment      String?         // For negative feedback or concerns

  @@index([phone])
  @@index([status])
  @@index([zoneId])
  @@index([cellId])
  @@index([conversionStatus])
  @@index([lastVisit])
  @@index([interests])
  @@index([educationLevel])
  @@index([ageRange])
}

enum FollowUpType {
  PHONE_CALL
  VISITATION
  ATTENDANCE_CHECK
}

enum FollowUpStatus {
  PENDING
  COMPLETED
  NOT_REACHABLE
  RESCHEDULED
  DECLINED
}

enum MilestoneType {
  JOINED_CELL
  JOINED_DEPARTMENT
  DCA_BASIC
  DCA_MATURITY
  ENCOUNTER
  DLI
  SUNDAY_SERVICE_ATTENDANCE
}

model FollowUp {
  id              String         @id @default(uuid())
  member          Member         @relation(fields: [memberId], references: [id])
  memberId        String
  type            FollowUpType
  status          FollowUpStatus @default(PENDING)
  notes           String?
  assignedTo      User          @relation("AssignedFollowUps", fields: [userId], references: [id])
  userId          String
  nextFollowUpDate DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([memberId])
  @@index([userId])
  @@index([nextFollowUpDate])
}

model Department {
  id          String            @id @default(uuid())
  name        String
  members     MemberDepartment[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model MemberDepartment {
  id           String     @id @default(uuid())
  member       Member     @relation(fields: [memberId], references: [id])
  memberId     String
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String
  joinDate     DateTime   @default(now())
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([memberId, departmentId])
}

model MemberMilestone {
  id          String        @id @default(uuid())
  member      Member        @relation(fields: [memberId], references: [id])
  memberId    String
  type        MilestoneType
  date        DateTime      @default(now())
  verified    Boolean       @default(false)
  verifiedBy  User?        @relation(fields: [verifierId], references: [id])
  verifierId  String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([memberId])
  @@index([type])
  @@index([verified])
  @@index([date])
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isRevoked   Boolean  @default(false)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Attendance {
  id        String   @id @default(uuid())
  member    Member   @relation(fields: [memberId], references: [id])
  memberId  String
  date      DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([date])
}

model Note {
  id        String   @id @default(uuid())
  member    Member   @relation(fields: [memberId], references: [id])
  memberId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
}